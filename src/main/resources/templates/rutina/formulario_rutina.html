<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Nueva Rutina</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/usuarios_entrenador.css}">
</head>
<body class="bg-light">
  <header>
  <nav class="navbar">
    <div class="logo">
      <img th:src="@{/img/logo_forta.png}" alt="Logo FortaGym" class="logo-img">
      <a th:href="@{/index}">FORTAGYM</a>
    </div>

    <ul class="nav-links">
      <li><a th:href="@{/sobreNosotros}">Sobre Nosotros</a></li>

      <!-- üîπ Men√∫ de usuario CORRECTO -->
      <li class="user-menu">
        <button class="user-btn">
          <img th:src="@{/img/user-icon.png}" alt="Usuario" class="user-icon">
          <span th:text="${#authentication.principal.username}">Usuario</span>
          <i class="arrow-down"></i>
        </button>

        <ul class="dropdown">
          <li><a th:href="@{/usuario}">Editar Perfil</a></li>
          <li>
            <form th:action="@{/logout}" method="post">
              <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
            </form>
          </li>
        </ul>
      </li>
    </ul>
  </nav>
</header>

<div class="container">
  <h3 class="mb-4 text-center">Asignar Rutina a <span th:text="${usuario.nombre}"></span></h3>

 <form th:action="@{/rutina/guardar}" th:object="${rutina}" method="post" class="card p-4 shadow-sm" onsubmit="return validarFormulario()">
  <input type="hidden" name="usuarioId" th:value="${usuario.id}"/>

  <div class="mb-3">
    <label for="observaciones" class="form-label">Observaciones / Lesiones</label>
    <textarea class="form-control" id="observaciones" th:field="*{observaciones}" rows="3" required></textarea>
  </div>

  <div class="mb-3">
    <label for="nombreEntrenador" class="form-label">Nombre del Entrenador</label>
    <input type="text" class="form-control" id="nombreEntrenador" th:field="*{nombreEntrenador}" required>
  </div>
    <table class="table table-bordered">
  <thead>
    <tr>
      <th>Ejercicio</th>
      <th>Series x Reps</th>
      <th>Descanso</th>
      <th>D√≠as</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tablaEjercicios">
    <tr>
      <td><input name="ejercicio" class="form-control"></td>
      <td><input name="seriesReps" class="form-control"></td>
      <td><input name="descanso" class="form-control"></td>
      <td><input name="dias" class="form-control"></td>
      <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>
    </tr>
  </tbody>
</table>

<button type="button" class="btn btn-outline-primary mb-3" onclick="agregarFila()">+ Agregar ejercicio</button>

<script>

(function() {
    const userMenu = document.querySelector('.user-menu');
    if (!userMenu) return;

    const btn = userMenu.querySelector('.user-btn');

    // Alternar al hacer click en el bot√≥n
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      userMenu.classList.toggle('open');
      // darle foco al primer elemento del men√∫ (mejora accesibilidad)
      const first = userMenu.querySelector('.dropdown a, .dropdown button, .dropdown input');
      if (userMenu.classList.contains('open') && first) first.focus();
    });

    // Cerrar al hacer click fuera
    document.addEventListener('click', function() {
      userMenu.classList.remove('open');
    });

    // Evitar que clics dentro del dropdown cierren (por ejemplo en el form)
    const dropdown = userMenu.querySelector('.dropdown');
    if (dropdown) {
      dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }

    // Soporte teclado: ESC para cerrar, Enter/Space para abrir cuando el bot√≥n est√° enfocado
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        userMenu.classList.remove('open');
      }
    });
    btn.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        userMenu.classList.toggle('open');
      }
    });
  })();
  function validarFormulario() {
    const filas = document.querySelectorAll("#tablaEjercicios tr");
    let valido = true;

    filas.forEach(fila => {
        const ejercicio = fila.querySelector("input[name='ejercicio']");
        const series = fila.querySelector("input[name='seriesReps']");
        const descanso = fila.querySelector("input[name='descanso']");
        const dias = fila.querySelector("input[name='dias']");

        // Reset estilos previos
        [ejercicio, series, descanso, dias].forEach(c => {
            c.classList.remove("is-invalid");
        });

        // ‚úî SOLO TEXTO para ejercicio
        const regexEjercicio = /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë ]{3,100}$/;

        // ‚úî EXACTO como tu @Pattern del backend
        const regexSeries = /^[0-9]{1,2}x[0-9]{1,3}$/;

        // ‚úî EXACTO como tu @Pattern backend: 60s, 90 seg, 2 min
        const regexDescanso = /^[0-9]{1,3}\s?(seg|s|min)$/;

        // ‚úî TEXTO de 3 a 50 caracteres
        const regexDias = /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë ]{3,50}$/;


        if (!regexEjercicio.test(ejercicio.value.trim())) {
            ejercicio.classList.add("is-invalid");
            valido = false;
        }

        if (!regexSeries.test(series.value.trim())) {
            series.classList.add("is-invalid");
            valido = false;
        }

        if (!regexDescanso.test(descanso.value.trim())) {
            descanso.classList.add("is-invalid");
            valido = false;
        }

        if (!regexDias.test(dias.value.trim())) {
            dias.classList.add("is-invalid");
            valido = false;
        }

    });

    if (!valido) {
        alert("‚ö† Algunos campos no cumplen el formato requerido.\nPor favor corr√≠gelos antes de guardar.");
    }

    return valido;
}

</script>


    <button type="submit" class="btn btn-success">Guardar Rutina</button>
    <a th:href="@{/rutina/usuarios}" class="btn btn-secondary ms-2">Cancelar</a>
  </form>
</div>
<footer>
        <p>¬© FortaGym 2025</p>
    </footer>
</body>
</html>
